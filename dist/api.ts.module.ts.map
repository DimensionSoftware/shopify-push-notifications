{"version":3,"file":"api.ts.module.ts","sources":["../src/api.ts"],"sourcesContent":["import * as queryString from 'query-string'\nimport * as crypto from 'crypto'\nimport { Push, PushResponse } from './index'\nimport { request, shopifyDomainFrom } from './helpers'\n\n// pull implementation-dependent fns in\n\n// implement push interface\nexport const push = (store: string, secret: string): Push => {\n  const shop = shopifyDomainFrom(store),\n    seed = generateSeed(),\n    url = `?seed=${seed}`,\n    sig = signature(secret, seed, url)\n  return {\n    token: async (token: string, customer?: string) => {\n      // securely upsert token & customer\n      return request(shop, '/push-token', sig, seed, { token, customer })\n    },\n    message: (title: string, body: string, data: object) => {\n      // push message\n      return request(shop, '/push-message', sig, seed, { title, body, data })\n    }\n  }\n}\n\n// helper fns\n// --------\nfunction generateSeed(): string {\n  return ((crypto.randomFillSync(new Uint32Array(1))[0] / 4294967295) * 100)\n    .toString()\n    .replace(/[^\\d]/, '')\n}\n\n// generate signature required for request\nfunction signature(secret: string, seed: string, url: string) {\n  const query = queryString.parse(url),\n    q = Object.assign({}, query),\n    sortedParams = Object.keys(q)\n      .sort()\n      .reduce((m, a) => {\n        m.push(`${a}=${q[a]}`)\n        return m\n      }, [])\n      .join(''),\n    hmac = crypto.createHmac('sha256', secret)\n  hmac.update(sortedParams)\n  return hmac.digest('hex')\n}\n"],"names":["push","store","secret","shop","shopifyDomainFrom","seed","generateSeed","url","sig","signature","token","customer","request","message","title","body","data","crypto","Uint32Array","toString","replace","query","queryString","q","Object","assign","sortedParams","keys","sort","reduce","m","a","join","hmac","update","digest"],"mappings":";;;;IAQaA,IAAI,aAAIC,KAAD,EAAgBC,MAAhB;MACZC,IAAI,GAAGC,iBAAiB,CAACH,KAAD,CAA9B;QACEI,IAAI,GAAGC,YAAY,EADrB;QAEEC,GAAG,cAAYF;QACfG,GAAG,GAAGC,SAAS,CAACP,MAAD,EAASG,IAAT,EAAeE,GAAf,CAHjB;SAIO;IACLG,KAAK,YAASA,KAAT,EAAwBC,QAAxB;;+BAEIC,OAAO,CAACT,IAAD,EAAO,aAAP,EAAsBK,GAAtB,EAA2BH,IAA3B,EAAiC;iBAAEK,KAAF;oBAASC;SAA1C,CAAd;OAFG;;;KADA;IAKLE,OAAO,YAAGC,KAAD,EAAgBC,IAAhB,EAA8BC,IAA9B;aAEAJ,OAAO,CAACT,IAAD,EAAO,eAAP,EAAwBK,GAAxB,EAA6BH,IAA7B,EAAmC;eAAES,KAAF;cAASC,IAAT;cAAeC;OAAlD,CAAd;;GAPJ;CALK;;AAmBP,SAASV,YAAT;SACS,CAAEW,cAAA,CAAsB,IAAIC,WAAJ,CAAgB,CAAhB,CAAtB,EAA0C,CAA1C,IAA+C,UAAhD,GAA8D,GAA/D,EACJC,QADI,GAEJC,OAFI,CAEI,OAFJ,EAEa,EAFb,CAAP;;;AAMF,SAASX,SAAT,CAAmBP,MAAnB,EAAmCG,IAAnC,EAAiDE,GAAjD;MACQc,KAAK,GAAGC,KAAA,CAAkBf,GAAlB,CAAd;QACEgB,CAAC,GAAGC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBJ,KAAlB,CADN;QAEEK,YAAY,GAAGF,MAAM,CAACG,IAAP,CAAYJ,CAAZ,EACZK,IADY,GAEZC,MAFY,WAEJC,CAAD,EAAIC,CAAJ;IACND,CAAC,CAAC9B,IAAF,EAAU+B,WAAKR,CAAC,CAACQ,CAAD;WACTD,CAAP;GAJW,EAKV,EALU,EAMZE,IANY,CAMP,EANO,CAFjB;QASEC,IAAI,GAAGhB,UAAA,CAAkB,QAAlB,EAA4Bf,MAA5B,CATT;EAUA+B,IAAI,CAACC,MAAL,CAAYR,YAAZ;SACOO,IAAI,CAACE,MAAL,CAAY,KAAZ,CAAP;;;;;"}