{"version":3,"file":"api.ts.module.ts","sources":["../src/api.ts"],"sourcesContent":["import fetch from 'node-fetch'\nimport * as queryString from 'query-string'\nimport * as crypto from 'crypto'\nimport { Push, PushResponse } from './index'\n\nexport const push = (store: string, secret: string): Push => {\n  const shop = shopifyDomainFrom(store)\n  return {\n    // insert token\n    token: async (token: string, customer?: string) => {\n      // make secure request with token in body\n      return request(shop, secret, '/push-token', { token, customer })\n    },\n    message: (title: string, body: string, data: object) => {\n      // push message\n      return request(shop, secret, '/push-message', { title, body, data })\n    }\n  }\n}\n\n// helper fns\n// --------\nfunction shopifyDomainFrom(domain: string) {\n  if (domain.indexOf('myshopify.com') >= 0) {\n    return domain\n  } else {\n    return domain.indexOf('.') === -1 ? `${domain}.myshopify.com` : domain // should be a shopify stores' full domain\n  }\n}\n\nfunction generateSeed(): string {\n  return ((crypto.randomFillSync(new Uint32Array(1))[0] / 4294967295) * 100)\n    .toString()\n    .replace(/[^\\d]/, '')\n}\n\n// generate signature required for request\nfunction signature(secret: string, seed: string, url: string) {\n  const query = queryString.parse(url),\n    q = Object.assign({}, query),\n    sortedParams = Object.keys(q)\n      .sort()\n      .reduce((m, a) => {\n        m.push(`${a}=${q[a]}`)\n        return m\n      }, [])\n      .join(''),\n    hmac = crypto.createHmac('sha256', secret)\n  hmac.update(sortedParams)\n  return hmac.digest('hex')\n}\n\nasync function request(\n  shop: string,\n  secret: string,\n  endpoint: string,\n  body: object\n) {\n  try {\n    const seed = generateSeed(),\n      url = `?seed=${seed}`,\n      sig = signature(secret, seed, url),\n      res = await fetch(\n        `https://${shop}/apps/dimensionauth/api${endpoint}?${queryString.stringify(\n          {\n            seed,\n            sig\n          }\n        )}`,\n        {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify(body)\n        }\n      ),\n      json = await res.json()\n    return json\n  } catch (error) {\n    return { success: false, error }\n  }\n}\n"],"names":["request","shop","secret","endpoint","body","seed","generateSeed","url","sig","signature","fetch","queryString","method","headers","JSON","stringify","res","json","error","success","push","store","shopifyDomainFrom","token","customer","message","title","data","domain","indexOf","crypto","Uint32Array","toString","replace","query","q","Object","assign","sortedParams","keys","sort","reduce","m","a","join","hmac","update","digest"],"mappings":";;;;;IAoDeA,oBACbC,MACAC,QACAC,UACAC;;8CAEI;UACIC,IAAI,GAAGC,YAAY,EADvB;YAEAC,GAAG,cAAYF;YACfG,GAAG,GAAGC,SAAS,CAACP,MAAD,EAASG,IAAT,EAAeE,GAAf,CAHf;6BAIYG,KAAK,eACJT,mCAA8BE,kBAAYQ,SAAA,CACnD;cACEN,IADF;aAEEG;OAHiD,KAMrD;QACEI,MAAM,EAAE,MADV;QAEEC,OAAO,EAAE;0BACS;SAHpB;QAKET,IAAI,EAAEU,IAAI,CAACC,SAAL,CAAeX,IAAf;OAZO,CAJjB,iBAIAY,GAJA;+BAmBaA,GAAG,CAACC,IAAJ,EAnBb;;iBAqBKC,OAAO;aACP;QAAEC,OAAO,EAAE,KAAX;eAAkBD;OAAzB;;;;;;;AA3EJ,IAAaE,IAAI,aAAIC,KAAD,EAAgBnB,MAAhB;MACZD,IAAI,GAAGqB,iBAAiB,CAACD,KAAD,CAA9B;SACO;IAELE,KAAK,YAASA,KAAT,EAAwBC,QAAxB;aAEIxB,OAAO,CAACC,IAAD,EAAOC,MAAP,EAAe,aAAf,EAA8B;eAAEqB,KAAF;kBAASC;OAAvC,CAAd;KAJG;IAMLC,OAAO,YAAGC,KAAD,EAAgBtB,IAAhB,EAA8BuB,IAA9B;aAEA3B,OAAO,CAACC,IAAD,EAAOC,MAAP,EAAe,eAAf,EAAgC;eAAEwB,KAAF;cAAStB,IAAT;cAAeuB;OAA/C,CAAd;;GARJ;CAFK;;AAiBP,SAASL,iBAAT,CAA2BM,MAA3B;MACMA,MAAM,CAACC,OAAP,CAAe,eAAf,KAAmC,CAAvC,EAA0C;WACjCD,MAAP;GADF,MAEO;WACEA,MAAM,CAACC,OAAP,CAAe,GAAf,MAAwB,CAAC,CAAzB,IAAgCD,6BAAyBA,MAAhE;;;;AAIJ,SAAStB,YAAT;SACS,CAAEwB,cAAA,CAAsB,IAAIC,WAAJ,CAAgB,CAAhB,CAAtB,EAA0C,CAA1C,IAA+C,UAAhD,GAA8D,GAA/D,EACJC,QADI,GAEJC,OAFI,CAEI,OAFJ,EAEa,EAFb,CAAP;;;AAMF,SAASxB,SAAT,CAAmBP,MAAnB,EAAmCG,IAAnC,EAAiDE,GAAjD;MACQ2B,KAAK,GAAGvB,KAAA,CAAkBJ,GAAlB,CAAd;QACE4B,CAAC,GAAGC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBH,KAAlB,CADN;QAEEI,YAAY,GAAGF,MAAM,CAACG,IAAP,CAAYJ,CAAZ,EACZK,IADY,GAEZC,MAFY,WAEJC,CAAD,EAAIC,CAAJ;IACND,CAAC,CAACtB,IAAF,EAAUuB,WAAKR,CAAC,CAACQ,CAAD;WACTD,CAAP;GAJW,EAKV,EALU,EAMZE,IANY,CAMP,EANO,CAFjB;QASEC,IAAI,GAAGf,UAAA,CAAkB,QAAlB,EAA4B5B,MAA5B,CATT;EAUA2C,IAAI,CAACC,MAAL,CAAYR,YAAZ;SACOO,IAAI,CAACE,MAAL,CAAY,KAAZ,CAAP;;;;;"}