{"version":3,"file":"api.ts.umd.js","sources":["../src/api.ts"],"sourcesContent":["import * as queryString from 'query-string'\nimport * as crypto from 'crypto'\nimport { Push, PushResponse } from './index'\nimport { request, shopifyDomainFrom } from './helpers'\n\n// pull implementation-dependent fns in\n\n// implement push interface\nexport const push = (store: string, secret: string): Push => {\n  const shop = shopifyDomainFrom(store),\n    seed = generateSeed(),\n    url = `?seed=${seed}`,\n    sig = signature(secret, seed, url)\n  return {\n    token: async (token: string, customer?: string) => {\n      // securely upsert token & customer\n      return request(shop, '/push-token', sig, seed, { token, customer })\n    },\n    message: (title: string, body: string, data: object) => {\n      // push message\n      return request(shop, '/push-message', sig, seed, { title, body, data })\n    }\n  }\n}\n\n// helper fns\n// --------\nfunction generateSeed(): string {\n  return ((crypto.randomFillSync(new Uint32Array(1))[0] / 4294967295) * 100)\n    .toString()\n    .replace(/[^\\d]/, '')\n}\n\n// generate signature required for request\nfunction signature(secret: string, seed: string, url: string) {\n  const query = queryString.parse(url),\n    q = Object.assign({}, query),\n    sortedParams = Object.keys(q)\n      .sort()\n      .reduce((m, a) => {\n        m.push(`${a}=${q[a]}`)\n        return m\n      }, [])\n      .join(''),\n    hmac = crypto.createHmac('sha256', secret)\n  hmac.update(sortedParams)\n  return hmac.digest('hex')\n}\n"],"names":["push","store","secret","shop","shopifyDomainFrom","seed","generateSeed","url","sig","signature","token","customer","request","message","title","body","data","crypto","Uint32Array","toString","replace","query","queryString","q","Object","assign","sortedParams","keys","sort","reduce","m","a","join","hmac","update","digest"],"mappings":";;;;;MAQaA,IAAI,aAAIC,KAAD,EAAgBC,MAAhB;QACZC,IAAI,GAAGC,4BAAiB,CAACH,KAAD,CAA9B;UACEI,IAAI,GAAGC,YAAY,EADrB;UAEEC,GAAG,cAAYF;UACfG,GAAG,GAAGC,SAAS,CAACP,MAAD,EAASG,IAAT,EAAeE,GAAf,CAHjB;WAIO;MACLG,KAAK,YAASA,KAAT,EAAwBC,QAAxB;;iCAEIC,kBAAO,CAACT,IAAD,EAAO,aAAP,EAAsBK,GAAtB,EAA2BH,IAA3B,EAAiC;mBAAEK,KAAF;sBAASC;WAA1C,CAAd;SAFG;;;OADA;MAKLE,OAAO,YAAGC,KAAD,EAAgBC,IAAhB,EAA8BC,IAA9B;eAEAJ,kBAAO,CAACT,IAAD,EAAO,eAAP,EAAwBK,GAAxB,EAA6BH,IAA7B,EAAmC;iBAAES,KAAF;gBAASC,IAAT;gBAAeC;SAAlD,CAAd;;KAPJ;GALK;;EAmBP,SAASV,YAAT;WACS,CAAEW,qBAAA,CAAsB,IAAIC,WAAJ,CAAgB,CAAhB,CAAtB,EAA0C,CAA1C,IAA+C,UAAhD,GAA8D,GAA/D,EACJC,QADI,GAEJC,OAFI,CAEI,OAFJ,EAEa,EAFb,CAAP;;;EAMF,SAASX,SAAT,CAAmBP,MAAnB,EAAmCG,IAAnC,EAAiDE,GAAjD;QACQc,KAAK,GAAGC,iBAAA,CAAkBf,GAAlB,CAAd;UACEgB,CAAC,GAAGC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBJ,KAAlB,CADN;UAEEK,YAAY,GAAGF,MAAM,CAACG,IAAP,CAAYJ,CAAZ,EACZK,IADY,GAEZC,MAFY,WAEJC,CAAD,EAAIC,CAAJ;MACND,CAAC,CAAC9B,IAAF,EAAU+B,WAAKR,CAAC,CAACQ,CAAD;aACTD,CAAP;KAJW,EAKV,EALU,EAMZE,IANY,CAMP,EANO,CAFjB;UASEC,IAAI,GAAGhB,iBAAA,CAAkB,QAAlB,EAA4Bf,MAA5B,CATT;IAUA+B,IAAI,CAACC,MAAL,CAAYR,YAAZ;WACOO,IAAI,CAACE,MAAL,CAAY,KAAZ,CAAP;;;;;;;;;"}