{"version":3,"file":"api.ts.umd.js","sources":["../src/api.ts"],"sourcesContent":["import fetch from 'node-fetch'\nimport * as queryString from 'query-string'\nimport * as crypto from 'crypto'\nimport { Push, PushResponse } from './index'\n\nexport const push = (store: string, secret: string): Push => {\n  const shop = shopifyDomainFrom(store)\n  return {\n    // insert token\n    token: async (token: string, customer?: string) => {\n      // make secure request with token in body\n      return request(shop, secret, '/push-token', { token, customer })\n    },\n    message: (title: string, body: string, data: object) => {\n      // push message\n      return request(shop, secret, '/push-message', { title, body, data })\n    }\n  }\n}\n\n// helper fns\n// --------\nfunction shopifyDomainFrom(domain: string) {\n  if (domain.indexOf('myshopify.com') >= 0) {\n    return domain\n  } else {\n    return domain.indexOf('.') === -1 ? `${domain}.myshopify.com` : domain // should be a shopify stores' full domain\n  }\n}\n\nfunction generateSeed(): string {\n  return ((crypto.randomFillSync(new Uint32Array(1))[0] / 4294967295) * 100)\n    .toString()\n    .replace(/[^\\d]/, '')\n}\n\n// generate signature required for request\nfunction signature(secret: string, seed: string, url: string) {\n  const query = queryString.parse(url),\n    q = Object.assign({}, query),\n    sortedParams = Object.keys(q)\n      .sort()\n      .reduce((m, a) => {\n        m.push(`${a}=${q[a]}`)\n        return m\n      }, [])\n      .join(''),\n    hmac = crypto.createHmac('sha256', secret)\n  hmac.update(sortedParams)\n  return hmac.digest('hex')\n}\n\nasync function request(\n  shop: string,\n  secret: string,\n  endpoint: string,\n  body: object\n) {\n  try {\n    const seed = generateSeed(),\n      url = `?seed=${seed}`,\n      sig = signature(secret, seed, url),\n      res = await fetch(\n        `https://${shop}/apps/dimensionauth/api${endpoint}?${queryString.stringify(\n          {\n            seed,\n            sig\n          }\n        )}`,\n        {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify(body)\n        }\n      ),\n      json = await res.json()\n    return json\n  } catch (error) {\n    return { success: false, error }\n  }\n}\n"],"names":["request","shop","secret","endpoint","body","seed","generateSeed","url","sig","signature","fetch","queryString","method","headers","JSON","stringify","res","json","error","success","push","store","shopifyDomainFrom","token","customer","message","title","data","domain","indexOf","crypto","Uint32Array","toString","replace","query","q","Object","assign","sortedParams","keys","sort","reduce","m","a","join","hmac","update","digest"],"mappings":";;;;;;;MAoDeA,oBACbC,MACAC,QACAC,UACAC;;2DAEI;YACIC,IAAI,GAAGC,YAAY,EADvB;cAEAC,GAAG,cAAYF;cACfG,GAAG,GAAGC,SAAS,CAACP,MAAD,EAASG,IAAT,EAAeE,GAAf,CAHf;+BAIYG,KAAK,eACJT,mCAA8BE,kBAAYQ,qBAAA,CACnD;gBACEN,IADF;eAEEG;SAHiD,KAMrD;UACEI,MAAM,EAAE,MADV;UAEEC,OAAO,EAAE;4BACS;WAHpB;UAKET,IAAI,EAAEU,IAAI,CAACC,SAAL,CAAeX,IAAf;SAZO,CAJjB,iBAIAY,GAJA;iCAmBaA,GAAG,CAACC,IAAJ,EAnBb;;mBAqBKC,OAAO;eACP;UAAEC,OAAO,EAAE,KAAX;iBAAkBD;SAAzB;;;;;;;AA3EJ,MAAaE,IAAI,aAAIC,KAAD,EAAgBnB,MAAhB;QACZD,IAAI,GAAGqB,iBAAiB,CAACD,KAAD,CAA9B;WACO;MAELE,KAAK,YAASA,KAAT,EAAwBC,QAAxB;eAEIxB,OAAO,CAACC,IAAD,EAAOC,MAAP,EAAe,aAAf,EAA8B;iBAAEqB,KAAF;oBAASC;SAAvC,CAAd;OAJG;MAMLC,OAAO,YAAGC,KAAD,EAAgBtB,IAAhB,EAA8BuB,IAA9B;eAEA3B,OAAO,CAACC,IAAD,EAAOC,MAAP,EAAe,eAAf,EAAgC;iBAAEwB,KAAF;gBAAStB,IAAT;gBAAeuB;SAA/C,CAAd;;KARJ;GAFK;;EAiBP,SAASL,iBAAT,CAA2BM,MAA3B;QACMA,MAAM,CAACC,OAAP,CAAe,eAAf,KAAmC,CAAvC,EAA0C;aACjCD,MAAP;KADF,MAEO;aACEA,MAAM,CAACC,OAAP,CAAe,GAAf,MAAwB,CAAC,CAAzB,IAAgCD,6BAAyBA,MAAhE;;;;EAIJ,SAAStB,YAAT;WACS,CAAEwB,qBAAA,CAAsB,IAAIC,WAAJ,CAAgB,CAAhB,CAAtB,EAA0C,CAA1C,IAA+C,UAAhD,GAA8D,GAA/D,EACJC,QADI,GAEJC,OAFI,CAEI,OAFJ,EAEa,EAFb,CAAP;;;EAMF,SAASxB,SAAT,CAAmBP,MAAnB,EAAmCG,IAAnC,EAAiDE,GAAjD;QACQ2B,KAAK,GAAGvB,iBAAA,CAAkBJ,GAAlB,CAAd;UACE4B,CAAC,GAAGC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBH,KAAlB,CADN;UAEEI,YAAY,GAAGF,MAAM,CAACG,IAAP,CAAYJ,CAAZ,EACZK,IADY,GAEZC,MAFY,WAEJC,CAAD,EAAIC,CAAJ;MACND,CAAC,CAACtB,IAAF,EAAUuB,WAAKR,CAAC,CAACQ,CAAD;aACTD,CAAP;KAJW,EAKV,EALU,EAMZE,IANY,CAMP,EANO,CAFjB;UASEC,IAAI,GAAGf,iBAAA,CAAkB,QAAlB,EAA4B5B,MAA5B,CATT;IAUA2C,IAAI,CAACC,MAAL,CAAYR,YAAZ;WACOO,IAAI,CAACE,MAAL,CAAY,KAAZ,CAAP;;;;;;;;;"}